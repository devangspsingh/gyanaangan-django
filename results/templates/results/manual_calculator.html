{% extends 'base.html' %}
{% load static %}

{% block title %}Manual SGPA Calculator{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold text-white mb-6">Manual SGPA Calculator</h1>
    <p class="text-gray-300 mb-4 max-w-2xl">
        Enter your subjects, marks, total marks, and credits to calculate your SGPA. This is useful if your result is not available in our database.
    </p>
    <!-- Switch for entry mode -->
    <div class="flex items-center mb-4">
        <label for="entry-mode-switch" class="mr-3 text-white font-semibold">Entry Mode:</label>
        <button id="entry-mode-switch" type="button" class="bg-blue-700 text-white px-4 py-2 rounded focus:outline-none">
            <span id="entry-mode-label">Total Marks</span>
        </button>
        <span class="ml-3 text-gray-300 text-sm">Switch between entering <b>total marks</b> or <b>theory + internal</b> for all subjects.</span>
    </div>
    <div class="bg-gray-800 rounded-lg p-6 mb-8">
        <form method="post" id="manual-calc-form">
            {% csrf_token %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-gray-700 rounded">
                    <thead>
                        <tr>
                            <th class="px-2 py-2 text-gray-300">Subject Name</th>
                            <th class="px-2 py-2 text-gray-300">Credit</th>
                            <th class="px-2 py-2 text-gray-300 entry-total">Marks Obtained</th>
                            <th class="px-2 py-2 text-gray-300 entry-theory-internal" style="display:none;">Theory</th>
                            <th class="px-2 py-2 text-gray-300 entry-theory-internal" style="display:none;">Internal</th>
                            <th class="px-2 py-2 text-gray-300">Total Marks</th>
                            <th class="px-2 py-2 text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="formset-area">
                        {{ formset.management_form }}
                        {% for form in formset %}
                        <tr class="subject-row">
                            <td class="px-2 py-2">
                                {{ form.subject_name }}
                            </td>
                            <td class="px-2 py-2">
                                {{ form.credit }}
                            </td>
                            <td class="px-2 py-2 entry-total">
                                {{ form.marks_obtained }}
                            </td>
                            <td class="px-2 py-2 entry-theory-internal" style="display:none;">
                                {{ form.theory_marks }}
                            </td>
                            <td class="px-2 py-2 entry-theory-internal" style="display:none;">
                                {{ form.internal_marks }}
                            </td>
                            <td class="px-2 py-2">
                                {{ form.total_marks }}
                            </td>
                            <td class="px-2 py-2">
                                <button type="button" class="delete-row bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="flex flex-col md:flex-row items-center justify-between mt-4">
                <div>
                    <button type="button" id="add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded mr-2">Add Subject</button>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded">Calculate SGPA</button>
                </div>
                <div class="mt-2 md:mt-0 text-yellow-300 text-xs">
                    <strong>Note:</strong> Total marks means <u>theory + internal</u>. You can enter either total marks directly or both theory and internal separately using the switch above.
                </div>
            </div>
            {% if error %}
                <div class="text-red-400 mt-2">{{ error }}</div>
            {% endif %}
        </form>
    </div>
    {% if show_result %}
        <div class="bg-gray-900 rounded-lg p-6 mb-8" id="manual-result-card">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <h2 class="text-2xl font-bold text-green-400 mb-2 md:mb-0">Your Manual SGPA Result</h2>
                {% if allow_image_download %}
                <button onclick="downloadResultImage()" class="bg-blue-700 text-white px-4 py-2 rounded flex items-center">
                    <img src="{% static 'images/logo white.png' %}" alt="GyanAangan" class="w-6 h-6 mr-2"> Download Result Image
                </button>
                {% endif %}
            </div>
            <div class="mb-4">
                <strong class="text-white">SGPA:</strong>
                <span class="text-2xl text-green-300 font-bold">{{ sgpa }}</span>
            </div>
            <div class="mb-4">
                <strong class="text-white">Total Marks:</strong>
                <span class="text-xl text-blue-300 font-bold">{{ total_marks }}</span>
            </div>
            <table class="min-w-full bg-gray-800 rounded mb-4">
                <thead>
                    <tr>
                        <th class="px-4 py-2 text-left text-gray-400">Subject</th>
                        <th class="px-4 py-2 text-left text-gray-400">Credit</th>
                        <th class="px-4 py-2 text-left text-gray-400">Marks</th>
                        <th class="px-4 py-2 text-left text-gray-400">Theory</th>
                        <th class="px-4 py-2 text-left text-gray-400">Internal</th>
                        <th class="px-4 py-2 text-left text-gray-400">Total Marks</th>
                        <th class="px-4 py-2 text-left text-gray-400">Percent</th>
                        <th class="px-4 py-2 text-left text-gray-400">Grade Point</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in subjects_data %}
                    <tr>
                        <td class="px-4 py-2 text-white">{{ s.name }}</td>
                        <td class="px-4 py-2 text-white">{{ s.credit }}</td>
                        <td class="px-4 py-2 text-white">{{ s.marks }}</td>
                        <td class="px-4 py-2 text-white">{{ s.theory|default_if_none:"-" }}</td>
                        <td class="px-4 py-2 text-white">{{ s.internal|default_if_none:"-" }}</td>
                        <td class="px-4 py-2 text-white">{{ s.total_marks }}</td>
                        <td class="px-4 py-2 text-white">{{ s.percent|floatformat:2 }}%</td>
                        <td class="px-4 py-2 text-white">{{ s.grade_point }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not show_full %}
                <div class="text-yellow-300 mt-2">
                    <strong>Login</strong> to save your calculation and get a downloadable result card!
                </div>
            {% endif %}
            <div class="flex items-center mt-4">
                <img src="{% static 'images/logo white.png' %}" alt="GyanAangan" class="w-8 h-8 mr-2">
                <span class="text-blue-300 font-bold">Powered by GyanAangan</span>
            </div>
        </div>
    {% endif %}
    <div class="bg-gray-800 rounded-lg p-6 mt-8">
        <h2 class="text-xl font-bold text-blue-400 mb-2">How is SGPA &amp; CGPA Calculated? (Ultimate Guide)</h2>
        <p class="text-gray-300 mb-2">
            <strong>SGPA (Semester Grade Point Average)</strong> is the weighted average of grade points earned in all subjects of a semester, based on their credits. <br>
            <strong>CGPA (Cumulative Grade Point Average)</strong> is the overall average of SGPA across all semesters completed so far.
        </p>
        <ul class="list-disc ml-6 text-gray-400 mb-2">
            <li>For each subject: <strong>Grade Point</strong> is assigned based on your percentage.</li>
            <li>SGPA = (Sum of (Grade Point × Credit) for all subjects) / (Total Credits)</li>
            <li>CGPA = (Sum of SGPA × Semester Credits for all semesters) / (Total Credits across semesters)</li>
            <li>AKTU 10-point scale: 90+% = 10, 80-89% = 9, 70-79% = 8, 60-69% = 7, 50-59% = 6, 40-49% = 5, below 40% = 0</li>
        </ul>
        <h3 class="text-lg font-semibold text-green-400 mt-6 mb-2">Step-by-Step Example</h3>
        <ol class="list-decimal ml-6 text-gray-400 mb-2">
            <li>Suppose you have 5 subjects in a semester with credits: 4, 4, 3, 3, 2.</li>
            <li>You score: 85, 78, 92, 65, 55 out of 100 in each subject respectively.</li>
            <li>Assign grade points: 85→9, 78→8, 92→10, 65→7, 55→6.</li>
            <li>Multiply each grade point by its credit and sum: (9×4)+(8×4)+(10×3)+(7×3)+(6×2) = 36+32+30+21+12 = 131</li>
            <li>Total credits = 4+4+3+3+2 = 16</li>
            <li>SGPA = 131 / 16 = 8.19</li>
            <li>Repeat for each semester and use the formula above to get CGPA.</li>
        </ol>
        <h3 class="text-lg font-semibold text-purple-400 mt-6 mb-2">Tips for Maximizing Your SGPA/CGPA</h3>
        <ul class="list-disc ml-6 text-gray-400 mb-2">
            <li>Focus on high-credit subjects as they impact your SGPA/CGPA more.</li>
            <li>Consistent performance across semesters helps maintain a strong CGPA.</li>
            <li>Use this calculator to plan your targets and track your progress.</li>
            <li>Understand your university's grading policy and credit structure.</li>
            <li>Practice time management and seek help early for difficult subjects.</li>
            <li>Remember: Improvement in later semesters can still boost your CGPA!</li>
        </ul>
        <h3 class="text-lg font-semibold text-yellow-400 mt-6 mb-2">Frequently Asked Questions</h3>
        <ul class="list-disc ml-6 text-gray-400 mb-2">
            <li><strong>Is SGPA/CGPA the same as percentage?</strong> No, but you can estimate percentage as (CGPA × 10) - 7.5 (AKTU rule).</li>
            <li><strong>Can I use this calculator for any university?</strong> Yes, if your university uses a similar 10-point scale and credit system.</li>
            <li><strong>What if I have a backlog?</strong> Backlog subjects are usually not counted in SGPA/CGPA until cleared.</li>
            <li><strong>Is this calculator accurate?</strong> It follows AKTU rules, but always verify with your official university results.</li>
        </ul>
        <p class="text-gray-400 mt-4">
            <strong>Disclaimer:</strong> This calculator is for informational purposes only. Always verify with your official university results and consult your academic handbook for precise rules.
        </p>
        <div class="mt-4 text-sm text-gray-500">
            <strong>SEO Keywords:</strong> SGPA calculator, CGPA calculator, AKTU grading system, how to calculate SGPA, how to calculate CGPA, university grade point average, semester result calculation, engineering result calculator, AKTU SGPA, AKTU CGPA, academic performance tips, best SGPA calculator, best CGPA calculator, Indian university grading, GyanAangan.
        </div>
    </div>
</div>
<script>
// Switch logic
let entryMode = 'total'; // or 'theory-internal'
document.getElementById('entry-mode-switch').addEventListener('click', function() {
    entryMode = entryMode === 'total' ? 'theory-internal' : 'total';
    document.getElementById('entry-mode-label').textContent = entryMode === 'total' ? 'Total Marks' : 'Theory + Internal';
    // Toggle columns
    document.querySelectorAll('.entry-total').forEach(el => el.style.display = entryMode === 'total' ? '' : 'none');
    document.querySelectorAll('.entry-theory-internal').forEach(el => el.style.display = entryMode === 'theory-internal' ? '' : 'none');
});

// Fix input field colors for all dynamically added rows
function fixInputColors(row) {
    row.querySelectorAll('input').forEach(function(input) {
        input.classList.add('bg-white', 'text-gray-900', 'rounded', 'px-2', 'py-1');
    });
}

function updateFormIndexes() {
    // Update form indexes for Django formset
    const rows = document.querySelectorAll('#formset-area tr.subject-row');
    rows.forEach(function(row, idx) {
        row.querySelectorAll('input').forEach(function(input) {
            input.name = input.name.replace(/form-\d+-/, `form-${idx}-`);
            input.id = input.id.replace(/form-\d+-/, `form-${idx}-`);
        });
    });
    document.getElementById('id_form-TOTAL_FORMS').value = rows.length;
}

document.getElementById('add-row-btn').addEventListener('click', function() {
    const area = document.getElementById('formset-area');
    const rows = area.querySelectorAll('tr.subject-row');
    if (rows.length > 0) {
        const lastRow = rows[rows.length - 1];
        const newRow = lastRow.cloneNode(true);
        newRow.querySelectorAll('input').forEach(function(input) { input.value = ''; });
        fixInputColors(newRow);
        area.appendChild(newRow);
        updateFormIndexes();
        // Respect current entry mode for new row
        if (entryMode === 'total') {
            newRow.querySelectorAll('.entry-total').forEach(el => el.style.display = '');
            newRow.querySelectorAll('.entry-theory-internal').forEach(el => el.style.display = 'none');
        } else {
            newRow.querySelectorAll('.entry-total').forEach(el => el.style.display = 'none');
            newRow.querySelectorAll('.entry-theory-internal').forEach(el => el.style.display = '');
        }
    }
});

document.getElementById('formset-area').addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-row')) {
        const rows = document.querySelectorAll('#formset-area tr.subject-row');
        if (rows.length > 1) {
            e.target.closest('tr').remove();
            updateFormIndexes();
        }
    }
});

function downloadResultImage() {
    // Use html2canvas or similar to download the result card as image
    import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js').then(() => {
        html2canvas(document.getElementById('manual-result-card')).then(function(canvas) {
            const link = document.createElement('a');
            link.download = 'gyanaangan-manual-result.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    });
}

// On page load, fix input colors and set initial entry mode
document.querySelectorAll('tr.subject-row').forEach(fixInputColors);
if (entryMode === 'total') {
    document.querySelectorAll('.entry-total').forEach(el => el.style.display = '');
    document.querySelectorAll('.entry-theory-internal').forEach(el => el.style.display = 'none');
} else {
    document.querySelectorAll('.entry-total').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.entry-theory-internal').forEach(el => el.style.display = '');
}
</script>
{% endblock %}
